<div class="page">
  <h1>AI-Powered Vehicle Condition Assessment</h1>
  <p class="subtitle">
    Upload pickup and return images of the vehicle. The system will analyze and summarize damages.
  </p>

  <div class="cards">
    <section class="upload-section">
      <!-- Pickup images -->
      <mat-card class="upload-card">
        <mat-card-title>Pickup Images</mat-card-title>
        <mat-card-content>
          <button mat-raised-button color="primary" (click)="pickupInput.click()">
            Select Pickup Images
          </button>

          <input
            #pickupInput
            type="file"
            accept="image/*"
            multiple
            hidden
            (change)="onPickupSelected($event)"
          />

          @if (pickupPreviews().length > 0) {
            <div class="preview-grid">
              @for (url of pickupPreviews(); track url) {
                <div class="preview-item">
                  <img [src]="url" alt="Pickup preview" />
                </div>
              }
            </div>
          }
        </mat-card-content>
      </mat-card>

      <!-- Return images -->
      <mat-card class="upload-card">
        <mat-card-title>Return Images</mat-card-title>
        <mat-card-content>
          <button mat-raised-button color="primary" (click)="returnInput.click()">
            Select Return Images
          </button>

          <input
            #returnInput
            type="file"
            accept="image/*"
            multiple
            hidden
            (change)="onReturnSelected($event)"
          />

          @if (returnPreviews().length > 0) {
            <div class="preview-grid">
              @for (url of returnPreviews(); track url) {
                <div class="preview-item">
                  <img [src]="url" alt="Return preview" />
                </div>
              }
            </div>
          }
        </mat-card-content>
      </mat-card>
    </section>
  </div>

  <div class="actions">
    <button
      mat-raised-button
      color="primary"
      (click)="createAssessment()"
      [disabled]="
        pickupPreviews().length === 0 ||
        returnPreviews().length === 0 ||
        assessmentApiService.loading()
      "
    >
      Create Assessment
    </button>

    <button mat-button (click)="reset()">Reset</button>

    @if (assessmentApiService.loading()) {
      <div class="loading-overlay">
        <mat-spinner class="spinner" [diameter]="60"></mat-spinner>
        <p>Please wait, analyzing images...</p>
      </div>
    }
  </div>

  @if (assessmentApiService.error()) {
    <p class="error">
      {{ assessmentApiService.error() }}
    </p>
  }

  @if (assessmentApiService.lastAssessment(); as assessment) {
    <mat-divider class="divider"></mat-divider>

    <mat-card class="result-card">
      <mat-card-title>Damage Summary</mat-card-title>
      <mat-card-content>
        <p>
          <strong>New damage count:</strong>
          {{ assessment.summary.newDamageCount }}
        </p>
        <p>
          <strong>Total estimated cost:</strong>
          ${{ assessment.summary.totalEstimatedCost }}
        </p>
        <p>
          <strong>Severity score:</strong>
          {{ assessment.summary.severityScore | number: '1.1-1' }}
        </p>

        <h3>Detected Damages</h3>
        <ul>
          @for (d of assessment.damages; track d.id) {
            <li>
              <strong>{{ d.panel }}</strong>
              – {{ d.type }} (severity {{ d.severity }}) → ${{ d.estimatedCost }}
            </li>
          }
        </ul>
      </mat-card-content>
    </mat-card>
  }
</div>
