<div class="page">
  <h1>AI-Powered Vehicle Condition Assessment</h1>
  <p class="subtitle">
    Upload pickup and return images of the vehicle. The system will analyze and summarize damages.
  </p>

  <div class="cards">
    <section class="upload-section">
      <!-- Pickup images -->
      <mat-card class="upload-card">
        <mat-card-title>Pickup Images</mat-card-title>
        <mat-card-content>
          <button mat-raised-button color="primary" (click)="pickupInput.click()">
            Select Pickup Images
          </button>

          <input
            #pickupInput
            type="file"
            accept="image/*"
            multiple
            hidden
            (change)="onPickupSelected($event)"
          />

          @if (pickupPreviews().length > 0) {
            <div class="preview-grid">
              @for (url of pickupPreviews(); track url) {
                <div class="preview-item">
                  <img [src]="url" alt="Pickup preview" />
                </div>
              }
            </div>
          }
        </mat-card-content>
      </mat-card>

      <!-- Return images -->
      <mat-card class="upload-card">
        <mat-card-title>Return Images</mat-card-title>
        <mat-card-content>
          <button mat-raised-button color="primary" (click)="returnInput.click()">
            Select Return Images
          </button>

          <input
            #returnInput
            type="file"
            accept="image/*"
            multiple
            hidden
            (change)="onReturnSelected($event)"
          />

          @if (returnPreviews().length > 0) {
            <div class="preview-grid">
              @for (url of returnPreviews(); track url) {
                <div class="preview-item">
                  <img [src]="url" alt="Return preview" />
                </div>
              }
            </div>
          }
        </mat-card-content>
      </mat-card>
    </section>
  </div>

  <div class="actions">
    <button
      mat-raised-button
      color="primary"
      (click)="createAssessment()"
      [disabled]="
        pickupPreviews().length === 0 ||
        returnPreviews().length === 0 ||
        assessmentApiService.loading()
      "
    >
      Create Assessment
    </button>

    <button mat-button (click)="reset()">Reset</button>

    @if (assessmentApiService.loading()) {
      <div class="loading-overlay">
        <mat-spinner class="spinner" [diameter]="60"></mat-spinner>
        <p>Please wait, analyzing images...</p>
      </div>
    }
  </div>

  @if (assessmentApiService.error()) {
    <p class="error">
      {{ assessmentApiService.error() }}
    </p>
  }

  @if (assessmentApiService.lastAssessment(); as assessment) {
    <mat-divider class="divider"></mat-divider>

    <div class="result-header-actions">
      <span class="result-title">Assessment Result</span>

      <button mat-stroked-button color="primary" (click)="exportAssessmentAsPdf(assessment)">
        <!-- <mat-icon>download</mat-icon> -->
        Export PDF
      </button>
    </div>

    <mat-card class="result-card" id="resultCard">
      <mat-card-header>
        <div mat-card-avatar class="assessment-icon"></div>
        <mat-card-title>Damage Assessment Summary</mat-card-title>
        <mat-card-subtitle> ID: {{ assessment.id }} </mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <!-- Top chips: date + severity -->
        <div class="summary-header">
          <span class="date-chip">
            <!-- <mat-icon>schedule</mat-icon> -->
            {{ assessment.createdAt | date: 'medium' }}
          </span>

          <span class="severity-chip" [ngClass]="severityClass(assessment.summary.severityScore)">
            <!-- <mat-icon>warning</mat-icon> -->
            Severity: {{ assessment.summary.severityScore | number: '1.1-1' }}/5
          </span>
        </div>

        <!-- Key numbers -->
        <div class="summary-grid">
          <div class="summary-item">
            <span class="label">New damage count</span>
            <span class="value">
              {{ assessment.summary.newDamageCount }}
            </span>
          </div>

          <div class="summary-item">
            <span class="label">Total estimated cost</span>
            <span class="value">
              ${{ assessment.summary.totalEstimatedCost | number: '1.0-0' }}
            </span>
          </div>
        </div>

        <h3 class="damages-title">Detected Damages</h3>

        @if (assessment.damages.length) {
          <ng-container>
            <div class="damages-list">
              @for (d of assessment.damages; track d.id) {
                <div class="damage-item">
                  <div class="damage-main">
                    <span class="damage-panel">{{ d.panel }}</span>
                    <span class="damage-type-chip">{{ d.type }}</span>
                  </div>

                  <div class="damage-meta">
                    <span class="severity-label"> Severity {{ d.severity }} </span>
                    <span class="cost"> ${{ d.estimatedCost | number: '1.0-0' }} </span>
                  </div>
                </div>
              }
            </div>
          </ng-container>
        } @else {
          <p class="no-damages">No new or worsened damages detected on return.</p>
        }
      </mat-card-content>
    </mat-card>
  }
</div>
